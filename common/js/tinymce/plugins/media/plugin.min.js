tinymce.PluginManager.add("media",function(e,t){function n(e){return-1!=e.indexOf(".mp3")?"audio/mpeg":-1!=e.indexOf(".wav")?"audio/wav":-1!=e.indexOf(".mp4")?"video/mp4":-1!=e.indexOf(".webm")?"video/webm":-1!=e.indexOf(".ogg")?"video/ogg":-1!=e.indexOf(".swf")?"application/x-shockwave-flash":""}function r(t){var n=e.settings.media_scripts;if(n)for(var r=0;r<n.length;r++)if(-1!==t.indexOf(n[r].filter))return n[r]}function i(){function t(e){var t,n,s,o;t=r.find("#width")[0],n=r.find("#height")[0],s=t.value(),o=n.value(),r.find("#constrain")[0].checked()&&i&&f&&s&&o&&(e.control==t?(o=Math.round(s/i*o),n.value(o)):(s=Math.round(o/f*s),t.value(s))),i=s,f=o}function n(){l=u(this.value()),this.parent().parent().fromJSON(l)}var r,i,f,l,c=[{name:"source1",type:"filepicker",filetype:"media",size:40,autofocus:!0,label:"Source",onchange:function(e){tinymce.each(e.meta,function(e,t){r.find("#"+t).value(e)})}}];e.settings.media_alt_source!==!1&&c.push({name:"source2",type:"filepicker",filetype:"media",size:40,label:"Alternative source"}),e.settings.media_poster!==!1&&c.push({name:"poster",type:"filepicker",filetype:"image",size:40,label:"Poster"}),e.settings.media_dimensions!==!1&&c.push({type:"container",label:"Dimensions",layout:"flex",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:3,size:3,onchange:t},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:3,size:3,onchange:t},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]}),l=a(e.selection.getNode()),i=l.width,f=l.height;var p={id:"mcemediasource",type:"textbox",flex:1,name:"embed",minWidth:300,minHeight:100,value:s(),multiline:!0,label:"Source"};p[h]=n,r=e.windowManager.open({title:"Insert/edit video",data:l,bodyType:"tabpanel",body:[{title:"Embed",type:"form",multiline:!0,minWidth:300,minHeight:150,onShowTab:function(){this.find("#embed").value(o(this.parent().toJSON()))},items:[{type:"label",text:"Paste your embed code below:",forId:"mcemediasource"},p]}],onSubmit:function(){var t,n,r,i;for(t=e.dom.select("img[data-mce-object]"),e.insertContent(o(this.toJSON())),n=e.dom.select("img[data-mce-object]"),r=0;r<t.length;r++)for(i=n.length-1;i>=0;i--)t[r]==n[i]&&n.splice(i,1);e.selection.select(n[0]),e.nodeChanged()}})}function s(){var t=e.selection.getNode();return t.getAttribute("data-mce-object")?e.selection.getContent():void 0}function o(i){var s="";if(!i.source1&&(tinymce.extend(i,u(i.embed)),!i.source1))return"";if(i.source2||(i.source2=""),i.poster||(i.poster=""),i.source1=e.convertURL(i.source1,"source"),i.source2=e.convertURL(i.source2,"source"),i.source1mime=n(i.source1),i.source2mime=n(i.source2),i.poster=e.convertURL(i.poster,"poster"),i.flashPlayerUrl=e.convertURL(t+"/moxieplayer.swf","movie"),tinymce.each(c,function(e){var t,n,r;if(t=e.regex.exec(i.source1)){for(r=e.url,n=0;t[n];n++)r=r.replace("$"+n,function(){return t[n]});i.source1=r,i.type=e.type,i.width=i.width||e.w,i.height=i.height||e.h}}),i.embed)s=l(i.embed,i,!0);else{var o=r(i.source1);o&&(i.type="script",i.width=o.width,i.height=o.height),i.width=i.width||300,i.height=i.height||150,tinymce.each(i,function(t,n){i[n]=e.dom.encode(t)}),"iframe"==i.type?s+='<iframe src="'+i.source1+'" width="'+i.width+'" height="'+i.height+'"></iframe>':"application/x-shockwave-flash"==i.source1mime?(s+='<object data="'+i.source1+'" width="'+i.width+'" height="'+i.height+'" type="application/x-shockwave-flash">',i.poster&&(s+='<img src="'+i.poster+'" width="'+i.width+'" height="'+i.height+'" />'),s+="</object>"):-1!=i.source1mime.indexOf("audio")?e.settings.audio_template_callback?s=e.settings.audio_template_callback(i):s+='<audio controls="controls" src="'+i.source1+'">'+(i.source2?'\n<source src="'+i.source2+'"'+(i.source2mime?' type="'+i.source2mime+'"':"")+" />\n":"")+"</audio>":"script"==i.type?s+='<script src="'+i.source1+'"></script>':s=e.settings.video_template_callback?e.settings.video_template_callback(i):'<video width="'+i.width+'" height="'+i.height+'"'+(i.poster?' poster="'+i.poster+'"':"")+' controls="controls">\n<source src="'+i.source1+'"'+(i.source1mime?' type="'+i.source1mime+'"':"")+" />\n"+(i.source2?'<source src="'+i.source2+'"'+(i.source2mime?' type="'+i.source2mime+'"':"")+" />\n":"")+"</video>"}return s}function u(e){var t={};return(new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!0,special:"script,noscript",start:function(e,n){if(t.source1||"param"!=e||(t.source1=n.map.movie),("iframe"==e||"object"==e||"embed"==e||"video"==e||"audio"==e)&&(t.type||(t.type=e),t=tinymce.extend(n.map,t)),"script"==e){var i=r(n.map.src);if(!i)return;t={type:"script",source1:n.map.src,width:i.width,height:i.height}}"source"==e&&(t.source1?t.source2||(t.source2=n.map.src):t.source1=n.map.src),"img"!=e||t.poster||(t.poster=n.map.src)}})).parse(e),t.source1=t.source1||t.src||t.data,t.source2=t.source2||"",t.poster=t.poster||"",t}function a(t){return t.getAttribute("data-mce-object")?u(e.serializer.serialize(t,{selection:!0})):{}}function f(t){if(e.settings.media_filter_html===!1)return t;var n=new tinymce.html.Writer;return(new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!1,special:"script,noscript",comment:function(e){n.comment(e)},cdata:function(e){n.cdata(e)},text:function(e,t){n.text(e,t)},start:function(e,t,r){if("script"!=e&&"noscript"!=e){for(var i=0;i<t.length;i++)if(0===t[i].name.indexOf("on"))return;n.start(e,t,r)}},end:function(e){"script"!=e&&"noscript"!=e&&n.end(e)}},new tinymce.html.Schema({}))).parse(t),n.getContent()}function l(e,t,n){function r(e,t){var n,r,i,s;for(n in t)if(i=""+t[n],e.map[n])for(r=e.length;r--;)s=e[r],s.name==n&&(i?(e.map[n]=i,s.value=i):(delete e.map[n],e.splice(r,1)));else i&&(e.push({name:n,value:i}),e.map[n]=i)}var i,s=new tinymce.html.Writer,o=0;return(new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!0,special:"script,noscript",comment:function(e){s.comment(e)},cdata:function(e){s.cdata(e)},text:function(e,t){s.text(e,t)},start:function(e,u,a){switch(e){case"video":case"object":case"embed":case"img":case"iframe":r(u,{width:t.width,height:t.height})}if(n)switch(e){case"video":r(u,{poster:t.poster,src:""}),t.source2&&r(u,{src:""});break;case"iframe":r(u,{src:t.source1});break;case"source":if(o++,2>=o&&(r(u,{src:t["source"+o],type:t["source"+o+"mime"]}),!t["source"+o]))return;break;case"img":if(!t.poster)return;i=!0}s.start(e,u,a)},end:function(e){if("video"==e&&n)for(var u=1;2>=u;u++)if(t["source"+u]){var a=[];a.map={},u>o&&(r(a,{src:t["source"+u],type:t["source"+u+"mime"]}),s.start("source",a,!0))}if(t.poster&&"object"==e&&n&&!i){var f=[];f.map={},r(f,{src:t.poster,width:t.width,height:t.height}),s.start("img",f,!0)}s.end(e)}},new tinymce.html.Schema({}))).parse(e),s.getContent()}var c=[{regex:/youtu\.be\/([\w\-.]+)/,type:"iframe",w:425,h:350,url:"//www.youtube.com/embed/$1"},{regex:/youtube\.com(.+)v=([^&]+)/,type:"iframe",w:425,h:350,url:"//www.youtube.com/embed/$2"},{regex:/vimeo\.com\/([0-9]+)/,type:"iframe",w:425,h:350,url:"//player.vimeo.com/video/$1?title=0&byline=0&portrait=0&color=8dc7dc"},{regex:/vimeo\.com\/(.*)\/([0-9]+)/,type:"iframe",w:425,h:350,url:"//player.vimeo.com/video/$2?title=0&byline=0"},{regex:/maps\.google\.([a-z]{2,3})\/maps\/(.+)msid=(.+)/,type:"iframe",w:425,h:350,url:'//maps.google.com/maps/ms?msid=$2&output=embed"'}],h=tinymce.Env.ie&&tinymce.Env.ie<=8?"onChange":"onInput";e.on("ResolveName",function(e){var t;1==e.target.nodeType&&(t=e.target.getAttribute("data-mce-object"))&&(e.name=t)}),e.on("preInit",function(){var t=e.schema.getSpecialElements();tinymce.each("video audio iframe object".split(" "),function(e){t[e]=new RegExp("</"+e+"[^>]*>","gi")});var n=e.schema.getBoolAttrs();tinymce.each("webkitallowfullscreen mozallowfullscreen allowfullscreen".split(" "),function(e){n[e]={}}),e.parser.addNodeFilter("iframe,video,audio,object,embed,script",function(t,n){for(var i,s,o,u,a,f,l,c,h=t.length;h--;)if(s=t[h],s.parent&&("script"!=s.name||(c=r(s.attr("src"))))){for(o=new tinymce.html.Node("img",1),o.shortEnded=!0,c&&(c.width&&s.attr("width",c.width.toString()),c.height&&s.attr("height",c.height.toString())),f=s.attributes,i=f.length;i--;)u=f[i].name,a=f[i].value,"width"!==u&&"height"!==u&&"style"!==u&&(("data"==u||"src"==u)&&(a=e.convertURL(a,u)),o.attr("data-mce-p-"+u,a));l=s.firstChild&&s.firstChild.value,l&&(o.attr("data-mce-html",escape(l)),o.firstChild=null),o.attr({width:s.attr("width")||"300",height:s.attr("height")||("audio"==n?"30":"150"),style:s.attr("style"),src:tinymce.Env.transparentSrc,"data-mce-object":n,"class":"mce-object mce-object-"+n}),s.replace(o)}}),e.serializer.addAttributeFilter("data-mce-object",function(e,t){for(var n,r,i,s,o,u,a,l=e.length;l--;)if(n=e[l],n.parent){for(a=n.attr(t),r=new tinymce.html.Node(a,1),"audio"!=a&&"script"!=a&&r.attr({width:n.attr("width"),height:n.attr("height")}),r.attr({style:n.attr("style")}),s=n.attributes,i=s.length;i--;){var c=s[i].name;0===c.indexOf("data-mce-p-")&&r.attr(c.substr(11),s[i].value)}"script"==a&&r.attr("type","text/javascript"),o=n.attr("data-mce-html"),o&&(u=new tinymce.html.Node("#text",3),u.raw=!0,u.value=f(unescape(o)),r.append(u)),n.replace(r)}})}),e.on("ObjectSelected",function(e){var t=e.target.getAttribute("data-mce-object");("audio"==t||"script"==t)&&e.preventDefault()}),e.on("objectResized",function(e){var t,n=e.target;n.getAttribute("data-mce-object")&&(t=n.getAttribute("data-mce-html"),t&&(t=unescape(t),n.setAttribute("data-mce-html",escape(l(t,{width:e.width,height:e.height})))))}),e.addButton("media",{tooltip:"Insert/edit video",onclick:i,stateSelector:["img[data-mce-object=video]","img[data-mce-object=iframe]"]}),e.addMenuItem("media",{icon:"media",text:"Insert video",onclick:i,context:"insert",prependToContext:!0})})